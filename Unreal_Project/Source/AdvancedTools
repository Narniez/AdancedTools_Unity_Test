#include "PhysicsStressTest.h"
#include "Misc/FileHelper.h"
#include "Misc/Paths.h"
#include "Components/PrimitiveComponent.h"
#include "HAL/PlatformFilemanager.h"

APhysicsStressTest::APhysicsStressTest()
{
    PrimaryActorTick.bCanEverTick = true;
    RootComponent = CreateDefaultSubobject<USceneComponent>(TEXT("RootComponent"));
}

void APhysicsStressTest::BeginPlay()
{
    GEngine->Exec(GetWorld(), TEXT("r.VSync 0"));
    Super::BeginPlay();

    FString FilePath = FPaths::ProjectSavedDir() + "Logs/" + fileName;
    if (!FPlatformFileManager::Get().GetPlatformFile().FileExists(*FilePath))
    {
        FString Header = "Time,ObjectCount,FPS,FrameTime(ms),TotalMemory(MB),ActiveObjects\n";
        FFileHelper::SaveStringToFile(Header, *FilePath);
    }
}

void APhysicsStressTest::StartTest(int NewCount)
{
    targetObjectCount = NewCount;

    for (AActor* Actor : spawnedActors)
    {
        if (Actor) Actor->Destroy();
    }
    spawnedActors.Empty();

    CSVContent.Empty();

    currentSpawnCount = 0;
    isSpawning = targetObjectCount > 0;
    isRecording = true;
    Timer = 0.0f;

    UE_LOG(LogTemp, Warning, TEXT("Starting Test with %d Objects..."), targetObjectCount);
}

void APhysicsStressTest::Tick(float DeltaTime)
{
    Super::Tick(DeltaTime);

    if (isSpawning)
    {
        int toSpawnThisFrame = FMath::Min(spawnsPerFrame, targetObjectCount - currentSpawnCount);
        for (int i = 0; i < toSpawnThisFrame; i++)
        {
            int spawnedIndex = currentSpawnCount + i;

            float X = (spawnedIndex % columnNumber) * spacing;
            float Y = 0.0f;
            float Z = 5.0f + (spawnedIndex / columnNumber) * spacing;

            X += FMath::RandRange(-0.1f, 0.1f);

            FVector SpawnLocation(X, Y, Z);
            FRotator SpawnRotation = FRotator::ZeroRotator;

            AActor* NewActor = GetWorld()->SpawnActor<AActor>(objectToSpawn, SpawnLocation, SpawnRotation);
            if (NewActor)
            {
                spawnedActors.Add(NewActor);
            }
        }

        currentSpawnCount += toSpawnThisFrame;

        if (currentSpawnCount >= targetObjectCount)
        {
            isSpawning = false;
        }
    }

    if (!isRecording) return;

    Timer += DeltaTime;

    if (Timer >= maxRecordingTime)
    {
        isRecording = false;
        SaveData();
        return;
    }

    float safeDelta = FMath::Max(DeltaTime, 1e-6f);
    float FPS = 1.0f / safeDelta;
    float FrameTimeMS = safeDelta * 1000.0f;

    FPlatformMemoryStats MemStats = FPlatformMemory::GetStats();
    int TotalMemoryMB = MemStats.UsedPhysical / (1024 * 1024);

    int ActiveCount = 0;
    for (AActor* Actor : spawnedActors)
    {
        if (Actor)
        {
            UPrimitiveComponent* PrimComp = Actor->FindComponentByClass<UPrimitiveComponent>();
            if (PrimComp && PrimComp->IsAnyRigidBodyAwake())
            {
                ActiveCount++;
            }
        }
    }

    FString Line = FString::Printf(TEXT("%.2f,%d,%.1f,%.4f,%d,%d\n"),
        Timer, targetObjectCount, FPS, FrameTimeMS, TotalMemoryMB, ActiveCount);

    CSVContent += Line;
}

void APhysicsStressTest::SaveData()
{
    FString FilePath = FPaths::ProjectSavedDir() + "Logs/" + fileName;
    FFileHelper::SaveStringToFile(CSVContent, *FilePath, FFileHelper::EEncodingOptions::AutoDetect, &IFileManager::Get(), FILEWRITE_Append);

    UE_LOG(LogTemp, Warning, TEXT("Test Complete. Data APPENDED to: %s"), *FilePath);
}